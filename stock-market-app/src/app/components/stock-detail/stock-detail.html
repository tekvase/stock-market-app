<div class="stock-detail-container">
  <button class="back-button" (click)="goBack()">
    ← Back to Dashboard
  </button>

  <div *ngIf="loading" class="loading">Loading stock details...</div>

  <div *ngIf="!loading && !stock" class="not-found">
    <h2>Stock not found</h2>
    <p>The stock symbol "{{ symbol }}" could not be found.</p>
  </div>

  <div *ngIf="!loading && stock" class="detail-content">
    <!-- Header: Symbol, Name, Price, Trade Info -->
    <div class="stock-header">
      <div class="title-section">
        <div class="symbol-row">
          <h1 class="stock-symbol">{{ stock.symbol }}</h1>
          <span class="sector-badge" *ngIf="details?.sector">{{ details.sector }}</span>
        </div>
        <p class="stock-name">{{ stock.name }}</p>
        <p class="company-country" *ngIf="details?.country">{{ details.country }}</p>
      </div>
      <div class="price-section">
        <div class="current-price">{{ stock.price | currency }}</div>
        <div class="price-change" [ngClass]="stock.change >= 0 ? 'positive' : 'negative'">
          <span>{{ stock.change >= 0 ? '+' : '' }}{{ stock.change | number:'1.2-2' }}</span>
          <span>({{ stock.change >= 0 ? '+' : '' }}{{ stock.changePercent | number:'1.2-2' }}%)</span>
        </div>
      </div>
      <div class="header-trade-row" *ngIf="tradeData">
        <div class="header-trade-field">
          <label>Buy Price</label>
          <div class="trade-input-wrap">
            <span class="input-prefix">$</span>
            <input type="number" [(ngModel)]="tradeData.buyPrice" (blur)="saveBuyPrice()" class="trade-input" step="0.01" min="0.01" />
          </div>
        </div>
        <div class="header-trade-field">
          <label>Shares</label>
          <input type="number" [(ngModel)]="tradeData.shares" (blur)="saveShares()" class="trade-input" step="1" min="0" />
        </div>
        <div class="header-trade-field header-pl" *ngIf="tradeData.buyPrice > 0 && stock">
          <label>P&amp;L</label>
          <span class="trade-pl-value" [class.positive]="stock.price >= tradeData.buyPrice" [class.negative]="stock.price < tradeData.buyPrice">
            {{ stock.price >= tradeData.buyPrice ? '+' : '' }}{{ getTradePLPercent() | number:'1.2-2' }}%
            ({{ stock.price >= tradeData.buyPrice ? '+$' : '-$' }}{{ (getTradePL() >= 0 ? getTradePL() : -getTradePL()) | number:'1.2-2' }})
          </span>
        </div>
        <button class="close-position-btn" (click)="openCloseDialog()">Close Position</button>
      </div>
    </div>

    <!-- Company Description -->
    <div class="description-card" *ngIf="details?.description">
      <h2>About</h2>
      <p>{{ details.description }}</p>
      <a *ngIf="details?.weburl" [href]="details.weburl" target="_blank" rel="noopener">Visit Website</a>
    </div>

    <!-- Key Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Open</div>
        <div class="stat-value">{{ stock.open | currency }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">High</div>
        <div class="stat-value">{{ stock.high | currency }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Low</div>
        <div class="stat-value">{{ stock.low | currency }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Prev Close</div>
        <div class="stat-value">{{ (stock.previousClose || (stock.price - stock.change)) | currency }}</div>
      </div>
      <div class="stat-card" *ngIf="details?.marketCap">
        <div class="stat-label">Market Cap</div>
        <div class="stat-value">{{ formatMarketCap(details.marketCap) }}</div>
      </div>
      <div class="stat-card" *ngIf="details?.epsTTM !== null">
        <div class="stat-label">EPS (TTM)</div>
        <div class="stat-value">{{ details.epsTTM | number:'1.2-2' }}</div>
      </div>
      <div class="stat-card" *ngIf="details?.peRatio !== null">
        <div class="stat-label">P/E Ratio</div>
        <div class="stat-value">{{ details.peRatio | number:'1.2-2' }}</div>
      </div>
      <div class="stat-card" *ngIf="details?.week52High !== null">
        <div class="stat-label">52W High</div>
        <div class="stat-value positive">{{ details.week52High | currency }}</div>
      </div>
      <div class="stat-card" *ngIf="details?.week52Low !== null">
        <div class="stat-label">52W Low</div>
        <div class="stat-value negative">{{ details.week52Low | currency }}</div>
      </div>
      <div class="stat-card" *ngIf="details?.nextEarnings">
        <div class="stat-label">Next Earnings</div>
        <div class="stat-value">{{ formatDate(details.nextEarnings) }}</div>
      </div>
      <div class="stat-card" *ngIf="details?.ipo">
        <div class="stat-label">IPO Date</div>
        <div class="stat-value">{{ details.ipo }}</div>
      </div>
    </div>

    <!-- Analyst Recommendations -->
    <div class="analyst-card" *ngIf="details?.recommendation">
      <h2>Analyst Recommendations</h2>
      <div class="analyst-bar-container">
        <div class="analyst-bar">
          <div class="bar-strong-buy" [style.flex]="details.recommendation.strongBuy" *ngIf="details.recommendation.strongBuy">
            {{ details.recommendation.strongBuy }}
          </div>
          <div class="bar-buy" [style.flex]="details.recommendation.buy" *ngIf="details.recommendation.buy">
            {{ details.recommendation.buy }}
          </div>
          <div class="bar-hold" [style.flex]="details.recommendation.hold" *ngIf="details.recommendation.hold">
            {{ details.recommendation.hold }}
          </div>
          <div class="bar-sell" [style.flex]="details.recommendation.sell" *ngIf="details.recommendation.sell">
            {{ details.recommendation.sell }}
          </div>
          <div class="bar-strong-sell" [style.flex]="details.recommendation.strongSell" *ngIf="details.recommendation.strongSell">
            {{ details.recommendation.strongSell }}
          </div>
        </div>
        <div class="analyst-legend">
          <span class="legend-item"><span class="dot strong-buy"></span> Strong Buy</span>
          <span class="legend-item"><span class="dot buy"></span> Buy</span>
          <span class="legend-item"><span class="dot hold"></span> Hold</span>
          <span class="legend-item"><span class="dot sell"></span> Sell</span>
          <span class="legend-item"><span class="dot strong-sell"></span> Strong Sell</span>
        </div>
      </div>
    </div>

    <!-- Price Chart -->
    <div class="chart-section" *ngIf="stockHistory.length > 0">
      <h2>Price History (Last 30 Days)</h2>
      <div class="chart-container">
        <div class="chart">
          <div *ngFor="let point of stockHistory; let i = index" class="bar-container">
            <span class="bar-price-label">${{ point.price.toFixed(2) }}</span>
            <div
              class="bar"
              [style.height.%]="getBarHeight(point.price)"
              [title]="point.date + ': $' + point.price.toFixed(2)"
            ></div>
          </div>
        </div>
        <div class="chart-labels">
          <span>{{ stockHistory[0]?.date }}</span>
          <span>{{ stockHistory[stockHistory.length - 1]?.date }}</span>
        </div>
      </div>
    </div>

    <!-- Company News -->
    <div class="news-section">
      <h2>Latest News</h2>
      <div *ngIf="loadingNews" class="loading-small">Loading news...</div>
      <div *ngIf="!loadingNews && companyNews.length === 0" class="no-data">No recent news found for {{ symbol }}.</div>
      <div class="news-list" *ngIf="!loadingNews && companyNews.length > 0">
        <a *ngFor="let item of companyNews" [href]="item.url" target="_blank" rel="noopener" class="news-item">
          <div class="news-content">
            <div class="news-title-row">
              <span class="news-title">{{ item.title }}</span>
              <span
                class="sentiment-badge"
                [class.sentiment-positive]="item.sentiment === 'positive'"
                [class.sentiment-negative]="item.sentiment === 'negative'"
                [class.sentiment-neutral]="item.sentiment === 'neutral'"
              >{{ item.sentimentLabel }}</span>
            </div>
            <div class="news-meta">
              <span class="news-source">{{ item.source }}</span>
              <span class="news-time">{{ item.time }}</span>
            </div>
          </div>
        </a>
      </div>
    </div>

  </div>

  <!-- Close Position Dialog -->
  <div class="close-overlay" *ngIf="showCloseDialog" (click)="cancelCloseDialog()">
    <div class="close-dialog" (click)="$event.stopPropagation()">
      <h3>Close Position — {{ symbol }}</h3>
      <div class="close-form">
        <label class="close-label">Enter your sell price</label>
        <input
          type="number"
          class="close-input"
          [(ngModel)]="closeSellPrice"
          placeholder="Enter sell price"
          step="0.01"
          min="0"
          autofocus
        />
        <div *ngIf="closeSellPrice > 0 && tradeData" class="close-preview"
          [class.positive]="closeSellPrice >= tradeData.buyPrice"
          [class.negative]="closeSellPrice < tradeData.buyPrice">
          P&amp;L: {{ closeSellPrice >= tradeData.buyPrice ? '+' : '' }}${{ getClosePL() | number:'1.2-2' }}
          ({{ closeSellPrice >= tradeData.buyPrice ? '+' : '' }}{{ getClosePLPercent() | number:'1.2-2' }}%)
        </div>
      </div>
      <div class="close-actions">
        <button class="close-cancel-btn" (click)="cancelCloseDialog()">Cancel</button>
        <button class="close-confirm-btn" (click)="closePosition()" [disabled]="closingPosition">
          {{ closingPosition ? 'Closing...' : 'Remove' }}
        </button>
      </div>
    </div>
  </div>
</div>
